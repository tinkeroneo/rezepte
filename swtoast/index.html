<!DOCTYPE html>
<html lang="de">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vegane Rezeptsammlung</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon-180.png">


</head>
<body>
  <header>ðŸŒ± Meine Rezepte</header>
  <main id="app"></main>

  <script type="module" src="./src/app.js"></script>

<script>
  // Offline app-shell cache + Update-Toast
  // - zeigt "Update verfÃ¼gbar" wenn ein neuer Service Worker installiert ist
  // - lÃ¤dt nach Klick neu (oder Ã¼bernimmt per SKIP_WAITING)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      const createToast = ({ title, message, actionLabel, onAction }) => {
        const el = document.createElement("div");
        el.className = "sw-toast";
        el.innerHTML = `
          <div class="sw-toast__card">
            <div class="sw-toast__title">${title}</div>
            <div class="sw-toast__msg">${message}</div>
            <div class="sw-toast__actions">
              ${actionLabel ? `<button class="sw-toast__btn" type="button">${actionLabel}</button>` : ""}
              <button class="sw-toast__x" type="button" aria-label="SchlieÃŸen">âœ•</button>
            </div>
          </div>
        `;
        const rm = () => el.remove();
        el.querySelector(".sw-toast__x")?.addEventListener("click", rm);
        el.querySelector(".sw-toast__btn")?.addEventListener("click", () => {
          try { onAction?.(); } finally { rm(); }
        });
        document.body.appendChild(el);
        return el;
      };

      try {
        const reg = await navigator.serviceWorker.register("./sw.js");

        // Wenn bereits ein SW "waiting" ist (z.B. nach erneutem Ã–ffnen)
        let reloadOnControllerChange = false;

        const maybeShowWaiting = () => {
          if (!reg.waiting) return;
          createToast({
            title: "Update verfÃ¼gbar",
            message: "Eine neue Version ist bereit.",
            actionLabel: "Neu laden",
            onAction: () => {
              reloadOnControllerChange = true;
              reg.waiting?.postMessage({ type: "SKIP_WAITING" });
            }
          });
        };
        maybeShowWaiting();

        reg.addEventListener("updatefound", () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener("statechange", () => {
            // installed + es gibt schon einen Controller => Update
            if (sw.state === "installed" && navigator.serviceWorker.controller) {
              maybeShowWaiting();
              // Falls der SW sofort aktiviert (skipWaiting im SW), zeigen wir trotzdem einen Hinweis
              if (!reg.waiting) {
                createToast({
                  title: "Update verfÃ¼gbar",
                  message: "Neue Version installiert. Bitte neu laden.",
                  actionLabel: "Neu laden",
                  onAction: () => window.location.reload()
                });
              }
            }
          });
        });

        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (reloadOnControllerChange) {
            window.location.reload();
          }
        });

        // Optional: regelmÃ¤ÃŸig nach Updates schauen (1x pro Stunde)
        setInterval(() => reg.update(), 60 * 60 * 1000);

      } catch {
        // SW registration failed (offline/blocked) â€“ ignore
      }
    });
  }
</script>

</body>
</html>
