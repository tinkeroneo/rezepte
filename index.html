<!DOCTYPE html>
<html lang="de">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rezeptwerk</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles/tokens.css" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/components.css" />
  <link rel="stylesheet" href="styles/views.css" />
<link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon-180.png">


</head>
<body>
  <header>
    <span class="header-badges">
      <button id="modeBadge" class="badge badge-btn" type="button" title="Speicher-Modus (klicken zum Umschalten)">â€”</button>
      
      <button id="radioHeaderBtn" class="badge badge-btn" type="button" title="Radio" hidden>ğŸ§</button>
      
      <button id="shopBadge" class="badge badge-btn"  type="button" title="Einkaufsliste">ğŸ§º</button>
  
      <button id="userBadge" class="badge badge-btn badge--warn" type="button" title="User MenÃ¼" hidden>ğŸ‘¤ USER</button>
      <div id="userMenu" class="popover" hidden>
      <div><button id="authBadge" class="badge badge-btn" type="button" title="Login/Logout">ğŸ”LOGIN</button></div>
      <div><button id="adminBadge" class="badge badge-btn" type="button" title="Admin" hidden>ğŸ› ï¸ ADMIN</button></div>
      <div><button id="themeBadge" class="badge badge-btn" type="button" title="Theme wechseln" hidden>ğŸŒ“ THEME</button></div>
      <div class="select-wrapper">
      <span class="icon">ğŸ”€</span>
      <select id="spaceSelect" class="badge badge-select" title="Space wÃ¤hlen"></select>
      </div>


      <div><span id="syncBadge" class="badge" title="Sync-Status" hidden>âŸ³ Sync-Status</span></div>
      </div>

  </header>
  <main id="app"></main>
  <div id="radioDockRoot"></div>

  <div id="globalTimersRoot" class="compact-mode"></div>
  <div id="updateToast" class="toast" ...></div>
  <script type="module" src="./src/app.js"></script>

<script>
  // Service Worker: App-Shell Cache + Update-Toast (priorisiert, kein Reload wÃ¤hrend aktiver Timer)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      const toast = document.getElementById("updateToast");
      const btnLater = document.getElementById("toastLater");
      const btnReload = document.getElementById("toastReload");

      const hasActiveTimers = () => {
        try {
          // Timer-Store wird von domain/timers.js genutzt
          const raw = localStorage.getItem("tinkeroneo_timers_v1") || "[]";
          const timers = JSON.parse(raw);
          return Array.isArray(timers) && timers.some(t => (t?.remainingSec ?? 0) > 0 || (t?.endAt ?? 0) > Date.now());
        } catch {
          return false;
        }
      };

      const inCookView = () => {
        try { return (location.hash || "").startsWith("#cook"); } catch { return false; }
      };

      const showToast = () => {
        if (!toast) return;
        // Priorisierung: kein Update-Toast wÃ¤hrend aktiver Timer oder im Kochmodus
        if (hasActiveTimers() || inCookView()) {
          // retry spÃ¤ter
          window.clearTimeout(window.__updateToastRetry);
          window.__updateToastRetry = window.setTimeout(showToast, 2500);
          return;
        }
        toast.classList.add("toast--show");
        toast.setAttribute("aria-hidden", "false");
      };
      const hideToast = () => {
        if (!toast) return;
        toast.classList.remove("toast--show");
        toast.setAttribute("aria-hidden", "true");
      };

      try {
        const reg = await navigator.serviceWorker.register("./sw.js");

        const requestSkipWaiting = () => {
          if (reg.waiting) {
            reg.waiting.postMessage({ type: "SKIP_WAITING" });
          }
        };

        // Buttons
        btnLater?.addEventListener("click", hideToast);
        btnReload?.addEventListener("click", () => {
          hideToast();
          requestSkipWaiting();
        });

        // Wenn ein Update gefunden & installiert wird: Toast anzeigen (statt sofort reload)
        reg.addEventListener("updatefound", () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener("statechange", () => {
            if (sw.state === "installed") {
              // installed + controller vorhanden => Update bereit
              if (navigator.serviceWorker.controller) {
                showToast();
              }
            }
          });
        });

        // Falls schon waiting (z.B. Tab lange offen)
        if (reg.waiting && navigator.serviceWorker.controller) {
          showToast();
        }

        // Sobald der neue SW die Kontrolle Ã¼bernimmt: reload
        let reloaded = false;
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (reloaded) return;
          reloaded = true;
          window.location.reload();
        });

        // optional: gelegentlich nach Updates schauen
        setInterval(() => reg.update(), 60 * 60 * 1000);
      } catch {
        // offline/blocked => ok
      }
    });
  }
</script>


  <div id="updateToast" class="toast" role="status" aria-live="polite" aria-hidden="true">
    <div class="toast__text">
      <div class="toast__title">Update verfÃ¼gbar</div>
      <div class="toast__msg">Neue Version ist bereit. Neu laden?</div>
    </div>
    <div class="toast__actions">
      <button id="toastLater" class="btn btn-ghost" type="button">SpÃ¤ter</button>
      <button id="toastReload" class="btn btn-primary" type="button">Neu laden</button>
    </div>
  </div>

</body>
</html>

<script type="module">
  console.log("module ok");

  import("./src/supabase.js").then(async m => {
    const ctx = await m.initAuthAndSpace();
    console.log("spaceId:", m.getSpaceId());
    console.log("ctx:", ctx);
  });
</script>
